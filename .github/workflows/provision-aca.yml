name: Provision - Azure Container Apps

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  provision:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure RG
        run: |
          az group create -n "${{ secrets.AZURE_RG }}" -l "${{ secrets.AZURE_LOCATION }}"

      - name: Create ACR if missing
        run: |
          ACR_NAME="acrtest3${GITHUB_RUN_ID}"
          echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV

          az acr show -n "$ACR_NAME" -g "${{ secrets.AZURE_RG }}" >/dev/null 2>&1 \
          || az acr create -n "$ACR_NAME" -g "${{ secrets.AZURE_RG }}" --sku Basic

          ACR_LOGIN_SERVER=$(az acr show -n "$ACR_NAME" -g "${{ secrets.AZURE_RG }}" --query loginServer -o tsv)
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> $GITHUB_ENV
          echo "ACR Login Server: $ACR_LOGIN_SERVER"

      - name: Install Container Apps extension
        run: |
          az extension add --name containerapp --upgrade

      - name: Create ACA Environment if missing
        run: |
          az containerapp env show -g "${{ secrets.AZURE_RG }}" -n "${{ secrets.ACA_ENV }}" >/dev/null 2>&1 \
          || az containerapp env create -g "${{ secrets.AZURE_RG }}" -n "${{ secrets.ACA_ENV }}" -l "${{ secrets.AZURE_LOCATION }}"

      - name: Create Container App (placeholder image)
        run: |
          # Placeholder image: hello-world (public). We'll update image in deploy workflow.
          az containerapp show -g "${{ secrets.AZURE_RG }}" -n "${{ secrets.ACA_APP }}" >/dev/null 2>&1 \
          || az containerapp create -g "${{ secrets.AZURE_RG }}" -n "${{ secrets.ACA_APP }}" \
              --environment "${{ secrets.ACA_ENV }}" \
              --image "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest" \
              --ingress external --target-port 8080

      - name: Print outputs (save ACR info)
        run: |
          echo "ACR_NAME=$ACR_NAME"
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER"
          echo ""
          echo "IMPORTANT: Add these as GitHub Secrets:"
          echo "ACR_NAME = $ACR_NAME"
          echo "ACR_LOGIN_SERVER = $ACR_LOGIN_SERVER"
